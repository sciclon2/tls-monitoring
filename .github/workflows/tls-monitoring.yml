name: TLS Certificate Monitoring

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

permissions:
  issues: write

jobs:
  monitor-certificates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install CA certificates
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run TLS monitoring script
        id: monitor
        run: |
          # Use secret if provided, otherwise use .env file
          DOMAINS="${{ secrets.MONITOR_DOMAINS }}"
          if [ -z "$DOMAINS" ]; then
            python main.py --threshold 5000
          else
            python main.py --domains "$DOMAINS" --threshold 5000
          fi
        continue-on-error: true
      
      - name: Extract alerts and create issues
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = ${{ steps.monitor.outputs.alerts || '[]' }};
            console.log(`Found ${alerts.length} alert(s)`);
            
            if (alerts.length === 0) {
              console.log('No alerts to process');
              return;
            }
            
            // Create an issue for each failing domain
            for (const alert of alerts) {
              let body = `## Certificate Alert for ${alert.domain}\n\n`;
              body += `**Status:** ${alert.status}\n\n`;
              
              if (alert.status === 'ERROR') {
                body += `**Error:** ${alert.error}\n\n`;
              } else {
                body += `**Expiration Date:** ${alert.expires_at ? new Date(alert.expires_at).toLocaleDateString() : 'Unknown'}\n`;
                body += `**Days Remaining:** ${alert.days_remaining}\n\n`;
              }
              
              // Include runbook URL if available (only in alerts, not in console output for privacy)
              if (alert.runbook_url) {
                body += `**Runbook:** [View Instructions](${alert.runbook_url})\n\n`;
              }
              
              body += `**Details:**\n`;
              body += `- Repository: [${context.repo.repo}](${context.server_url}/${context.repo.owner}/${context.repo.repo})\n`;
              body += `- Triggered: ${new Date().toISOString()}\n`;
              body += `- Workflow: [View Logs](${context.server_url}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;
              body += `Take action to renew or fix the certificate.`;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `⚠️ Certificate Alert: ${alert.domain}`,
                body: body,
                labels: ['security', 'certificate-alert']
              });
              console.log(`Created issue for ${alert.domain}`);
            }
