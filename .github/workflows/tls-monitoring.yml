name: TLS Certificate Monitoring

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  monitor-certificates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run TLS monitoring script
        id: monitor
        run: python main.py
        continue-on-error: true
      
      - name: Create GitHub Issue on certificate alert
        if: steps.monitor.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ TLS Certificate Expiration Alert',
              body: `## Certificate Expiration Alert\n\nThe TLS monitoring job detected certificate(s) below the expiration threshold.\n\n**Details:**\n- Repository: ${context.repo.repo}\n- Triggered: ${new Date().toISOString()}\n- Action: [View Logs](${context.server_url}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\nCheck the workflow logs above for certificate details and take action to renew the certificate(s).`,
              labels: ['security', 'certificate-alert']
            })
